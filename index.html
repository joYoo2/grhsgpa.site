<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GRHS GPA Calculator ‚Äî PDF Import</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f9fafb;min-height:100vh;padding:.5rem}
    .container{max-width:1400px;margin:0 auto}
    .header{text-align:center;margin-bottom:1rem}
    .header h1{font-size:1.5rem;font-weight:700;color:#1f2937;margin-bottom:.25rem}

    .tab-navigation{display:flex;background:#fff;border-radius:.375rem;box-shadow:0 1px 2px rgba(0,0,0,.1);overflow:hidden;margin-bottom:1rem}
    .tab-button{flex:1;padding:.5rem .75rem;border:none;background:#fff;color:#6b7280;cursor:pointer;transition:.2s;display:flex;align-items:center;justify-content:center;gap:.25rem;font-size:.875rem}
    .tab-button:hover{background:#f9fafb}
    .tab-button.active{background:#3b82f6;color:#fff}

    .card{background:#fff;border-radius:.375rem;box-shadow:0 1px 2px rgba(0,0,0,.1);padding:.75rem;margin-bottom:.75rem}
    .card h2{font-size:1rem;font-weight:600;margin-bottom:.5rem;color:#1f2937}
    .card h3{font-size:.875rem;font-weight:600;margin-bottom:.5rem;color:#1f2937}
    .gpa-display{display:flex;justify-content:center;gap:1rem;margin-bottom:.5rem}
    .gpa-box{text-align:center;padding:.75rem 1.5rem;border-radius:.375rem;background:#dcfce7;flex:1;max-width:200px}
    .gpa-box.unweighted{background:#dbeafe}
    .gpa-value{font-size:1.5rem;font-weight:700;margin-bottom:.125rem}
    .gpa-value.weighted{color:#16a34a}
    .gpa-value.unweighted{color:#2563eb}
    .gpa-label{font-size:.75rem;color:#6b7280}
    .button{padding:.25rem .5rem;border:none;border-radius:.25rem;cursor:pointer;font-size:.75rem;transition:.2s;display:inline-flex;align-items:center;gap:.25rem}
    .button.primary{background:#3b82f6;color:#fff}
    .button.primary:hover{background:#2563eb}
    .button.success{background:#10b981;color:#fff}
    .button.success:hover{background:#059669}
    .button.secondary{background:#6b7280;color:#fff}
    .button.secondary:hover{background:#4b5563}
    .button.danger{background:transparent;color:#ef4444;padding:.125rem .25rem;font-size:.875rem;font-weight:700;min-width:18px;height:18px;justify-content:center;border:none;border-radius:0}
    .button.danger:hover{color:#dc2626;background:rgba(239,68,68,.1)}
    .form-group{margin-bottom:.25rem}
    .form-label{display:block;font-size:.7rem;font-weight:500;color:#374151;margin-bottom:.125rem}
    .form-input,.form-select{width:100%;padding:.25rem .375rem;border:1px solid #d1d5db;border-radius:.25rem;font-size:.75rem;background:#fff}
    .form-input:focus,.form-select:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 2px rgba(59,130,246,.1)}

    .course-grid{display:grid;grid-template-columns:2fr .8fr .8fr .8fr auto;gap:.375rem;align-items:end;padding:.375rem;border:1px solid #e5e7eb;border-radius:.25rem;margin-bottom:.1rem}
    .course-header{display:grid;grid-template-columns:2fr .8fr .8fr .8fr auto;gap:.375rem;font-weight:600;font-size:.75rem;color:#6b7280;padding:.375rem;border:1px solid #e5e7eb;border-bottom:none;border-radius:.25rem .25rem 0 0;background:#f3f4f6}
    .years-grid{display:grid;grid-template-columns:1fr 1fr;gap:.75rem;margin-bottom:.75rem}
    .year-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem;padding-bottom:.375rem;border-bottom:1px solid #e5e7eb;cursor:grab}
    .year-info{display:flex;flex-direction:column;gap:.25rem}
    .year-name{font-size:.875rem;font-weight:600;border:none;background:transparent;outline:none;color:#1f2937;padding:0;margin:0}
    .year-gpa{font-size:.7rem;color:#6b7280;font-weight:400}
    .year-buttons{display:flex;flex-direction:column;gap:.25rem;align-items:flex-end}
    .empty-state{text-align:center;padding:1rem;color:#6b7280;font-size:.75rem}
    .hidden{display:none}

    .drag-over-top{box-shadow:inset 0 3px 0 0 #3b82f6}
    .drag-over-bottom{box-shadow:inset 0 -3px 0 0 #3b82f6}

    .custom-dropdown{position:relative;width:100%}
    .custom-dropdown-input{width:100%;padding:.25rem .375rem;border:1px solid #d1d5db;border-radius:.25rem;font-size:.75rem;background:#fff;cursor:text}
    .custom-dropdown-input:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 2px rgba(59,130,246,.1)}
    .custom-dropdown-list{position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #d1d5db;border-top:none;border-radius:0 0 .25rem .25rem;max-height:240px;overflow-y:auto;z-index:1000;box-shadow:0 4px 6px -1px rgba(0,0,0,.1)}
    .custom-dropdown-item{padding:.375rem .5rem;cursor:pointer;font-size:.75rem;border-bottom:1px solid #f3f4f6}
    .custom-dropdown-item:hover,.custom-dropdown-item.highlighted{background:#f9fafb}
    .custom-dropdown-item:last-child{border-bottom:none}
    .no-results{padding:.375rem .5rem;color:#6b7280;font-style:italic;font-size:.75rem}

    .debug{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace;font-size:.72rem;white-space:pre-wrap;background:#f3f4f6;border:1px dashed #cbd5e1;border-radius:.375rem;padding:.5rem}

    @media (max-width:768px){
      .years-grid{grid-template-columns:1fr}
      .course-grid{grid-template-columns:1fr;gap:.25rem}
      .year-header{flex-direction:column;gap:.5rem;align-items:stretch}
      .year-buttons{flex-direction:row;justify-content:center}
      .gpa-display{flex-direction:column;align-items:center}
    }
  </style>
  <!-- PDF.js (client-only) -->
  <script src="https://unpkg.com/pdfjs-dist@4.8.69/build/pdf.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="header"><h1>GRHS GPA Calculator</h1></div>

    <div class="tab-navigation">
      <button class="tab-button active" onclick="switchTab('gpa')" id="gpa-tab">üìä GPA Calculator</button>
      <button class="tab-button" onclick="switchTab('grade')" id="grade-tab">üìñ Grade Calculator</button>
    </div>

    <div id="gpa-content">
      <div class="card">
        <h2>Current GPA</h2>
        <div class="gpa-display">
          <div class="gpa-box weighted"><div class="gpa-value weighted" id="weighted-gpa">0.000</div><div class="gpa-label">Weighted GPA</div></div>
          <div class="gpa-box unweighted"><div class="gpa-value unweighted" id="unweighted-gpa">0.000</div><div class="gpa-label">Unweighted GPA</div></div>
        </div>
      </div>

      <div class="card">
        <h3>Data Management</h3>
        <div style="display:flex;gap:.5rem;align-items:center;flex-wrap:wrap">
          <button class="button primary" onclick="exportData()">üíæ Export Data</button>
          <label class="button success" for="import-file">üìÅ Import Data</label>
          <input type="file" id="import-file" class="hidden" accept=".json" onchange="importData(event)">
        </div>
      </div>

      <div class="years-grid" id="years-container"></div>
      <div class="add-year-section"><button class="button success" onclick="addYear()">‚ûï Add New Year</button></div>
    </div>

    <div id="grade-content" class="hidden">
      <div class="card">
        <h2>Grade Calculator</h2>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:.5rem;margin-bottom:.75rem">
          <div class="form-group">
            <label class="form-label">Course Type</label>
            <div style="display:flex;flex-direction:column;gap:.25rem">
              <label class="checkbox-item"><input type="checkbox" id="is-ap" onchange="updateGradeInputs()"> AP Course (No Final Exam)</label>
              <label class="checkbox-item"><input type="checkbox" id="is-semester" onchange="updateGradeInputs()"> Semester Course (2 Marking Periods)</label>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Marking Period Grades (0-100)</label>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:.5rem;margin-bottom:.75rem">
            <div class="form-group"><label class="form-label">MP 1</label><input type="number" id="mp1" class="form-input" min="0" max="100" oninput="calculateFinalGrade()"></div>
            <div class="form-group"><label class="form-label">MP 2</label><input type="number" id="mp2" class="form-input" min="0" max="100" oninput="calculateFinalGrade()"></div>
            <div class="form-group" id="mp3-container"><label class="form-label">MP 3</label><input type="number" id="mp3" class="form-input" min="0" max="100" oninput="calculateFinalGrade()"></div>
            <div class="form-group" id="mp4-container"><label class="form-label">MP 4</label><input type="number" id="mp4" class="form-input" min="0" max="100" oninput="calculateFinalGrade()"></div>
          </div>
        </div>
        <div class="form-group" id="final-exam-container"><label class="form-label">Final Exam Grade (10%)</label><input type="number" id="final-exam" class="form-input" min="0" max="100" style="max-width:300px" oninput="calculateFinalGrade()"></div>
        <div id="grade-results" class="hidden">
          <div class="card" style="margin:0">
            <h3>Final Course Grade</h3>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:.5rem">
              <div><div class="form-label">Grade Points</div><div class="gpa-value unweighted" id="final-points" style="font-size:1rem">--</div></div>
              <div><div class="form-label">Letter Grade</div><div class="gpa-value weighted" id="final-letter" style="font-size:1rem">--</div></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="debug-card" class="card hidden">
      <h3>PDF Text (for debugging)</h3>
      <p class="form-label">This shows exactly what the PDF reader extracted. Toggle from the year card.</p>
      <div id="pdf-debug" class="debug"></div>
    </div>
  </div>

  <script>
    // ===== Course catalog (same structure you already use) =====
    const courseCatalog = {};
    Object.assign(courseCatalog, {
      // ---- ENGLISH ----
      'Adv. English 10': { code: '1412', credits: 5, level: 'ADV', semester: false, subject: 'English' },
      'Adv. Journalism II': { code: '1833', credits: 5, level: 'CP', semester: false, subject: 'English' },
      'Adv. Journalism III': { code: '1834', credits: 5, level: 'CP', semester: false, subject: 'English' },
      'Adv. Journalism IV': { code: '1852', credits: 5, level: 'H', semester: false, subject: 'English' },
      'AP English Lang/ Comp': { code: '1510', credits: 5, level: 'AP', semester: false, subject: 'English' },
      'AP English Lit/ Comp': { code: '1610', credits: 5, level: 'AP', semester: false, subject: 'English' },
      'Creative Writing A': { code: '1843', credits: 2.5, level: 'CP', semester: true, subject: 'English' },
      'Creative Writing B': { code: '1853', credits: 2.5, level: 'CP', semester: true, subject: 'English' },
      'English 9': { code: '1313', credits: 5, level: 'CP', semester: false, subject: 'English' },
      'English 10': { code: '1413', credits: 5, level: 'CP', semester: false, subject: 'English' },
      'English 11': { code: '1513', credits: 5, level: 'CP', semester: false, subject: 'English' },
      'English 12 - Contemporary Fiction': { code: '1643', credits: 5, level: 'CP', semester: false, subject: 'English' },
      'Hon. Eng. 12 - Contemp. Fiction': { code: '1641', credits: 5, level: 'H', semester: false, subject: 'English' },
      'Honors English 11': { code: '1511', credits: 5, level: 'H', semester: false, subject: 'English' },
      'Honors Journalism IV': { code: '1835', credits: 5, level: 'H', semester: false, subject: 'English' },
      'Intro. To Documentary Film': { code: '2733', credits: 2.5, level: 'CP', semester: true, subject: 'English' },
      'Journalism I': { code: '1832', credits: 2.5, level: 'CP', semester: true, subject: 'English' },
      'Literature & Social Justice': { code: '1893', credits: 5, level: 'CP', semester: false, subject: 'English' },
      'Public Speaking': { code: '1353', credits: 2.5, level: 'CP', semester: true, subject: 'English' },
      'The Graphic Novel': { code: '1673', credits: 2.5, level: 'CP', semester: true, subject: 'English' },
      'Writers Workshop A': { code: '1863', credits: 2.5, level: 'CP', semester: true, subject: 'English' },
      'Writers Workshop B': { code: '1873', credits: 2.5, level: 'CP', semester: true, subject: 'English' },
      // add the rest as you go
    });

    const courseCatalogByCode = (() => {
      const map = {}; for (const [name, data] of Object.entries(courseCatalog)) { if (data.code) map[String(data.code)] = { ...data, name }; } return map;
    })();

    const letterGrades = ['A+','A','A-','B+','B','B-','C+','C','C-','D+','D','D-','F'];
    const gradePoints = { 'A+':4.3,'A':4.0,'A-':3.7,'B+':3.3,'B':3.0,'B-':2.7,'C+':2.3,'C':2.0,'C-':1.7,'D+':1.3,'D':1.0,'D-':0.7,'F':0.0 };
    const unweightedGradePoints = { 'A+':4.0,'A':4.0,'A-':3.7,'B+':3.3,'B':3.0,'B-':2.7,'C+':2.3,'C':2.0,'C-':1.7,'D+':1.3,'D':1.0,'D-':0.7,'F':0.0 };
    const courseLevels = ['CP','ADV','H','AP'];
    const levelWeights = { 'CP':0, 'ADV':0, 'H':0.3, 'AP':0.5 };

    let years = [];

    document.addEventListener('DOMContentLoaded', () => {
      // PDF.js worker
      if (window['pdfjsLib']) {
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@4.8.69/build/pdf.worker.min.js';
      }
      if (years.length === 0) addYear();
      updateGPA();
      updateGradeInputs();
    });

    function switchTab(tab){ byId('gpa-tab').classList.toggle('active', tab==='gpa'); byId('grade-tab').classList.toggle('active', tab==='grade'); byId('gpa-content').classList.toggle('hidden', tab!=='gpa'); byId('grade-content').classList.toggle('hidden', tab!=='grade'); }

    function addYear(){ years.push({ id: Date.now()+Math.random(), name: `Year ${years.length+1}`, courses: [] }); renderYears(); updateGPA(); }
    function removeYear(id){ years = years.filter(y=>y.id!==id); renderYears(); updateGPA(); }

    function addCourse(yearId){ const y=years.find(y=>y.id===yearId); if(!y) return; y.courses.push({ id: Date.now()+Math.random(), code:'', name:'', letterGrade:'A', credits:5, level:'CP', isCustom:true }); renderYears(); updateGPA(); }
    function removeCourse(yearId, courseId){ const y=years.find(y=>y.id===yearId); if(!y) return; y.courses = y.courses.filter(c=>c.id!==courseId); renderYears(); updateGPA(); }

    function updateCourse(yearId, courseId, field, value){
      const y=years.find(y=>y.id===yearId); if(!y) return; const c=y.courses.find(c=>c.id===courseId); if(!c) return;
      if (field==='name') {
        c.name = value;
        if(courseCatalog[value]){
          const d=courseCatalog[value]; c.code=d.code||''; c.credits=d.credits; c.level=d.level; c.isCustom=false;
        } else if (value.trim()!==''){ c.isCustom=true; }
      } else if (field==='letterGrade') { c.letterGrade = value; }
      else if (field==='credits') { c.credits = value; }
      else if (field==='level') { c.level = value; }
      renderYears(); updateGPA();
    }

    function calculateGPA(courses, weighted=true){ let pts=0, cr=0; courses.forEach(c=>{ const n=(c.name||'').toLowerCase(); if(n.includes('physical education')||n.includes('health')) return; const base=(weighted?gradePoints:unweightedGradePoints)[c.letterGrade]||0; const add=weighted?(levelWeights[c.level]||0):0; pts+=(base+add)*(c.credits||0); cr+=(c.credits||0); }); return cr>0?(pts/cr).toFixed(3):'0.000'; }
    function updateGPA(){ const all=years.flatMap(y=>y.courses); byId('weighted-gpa').textContent=calculateGPA(all,true); byId('unweighted-gpa').textContent=calculateGPA(all,false); }

    function renderYears(){
      const container = byId('years-container'); container.innerHTML='';
      years.forEach((y)=>{
        const yearDiv=document.createElement('div'); yearDiv.className='card';
        const weighted=calculateGPA(y.courses,true); const unweighted=calculateGPA(y.courses,false);
        const credits=y.courses.reduce((s,c)=>{ const n=(c.name||'').toLowerCase(); if(n.includes('physical education')||n.includes('health')) return s; return s+(c.credits||0); },0);

        let coursesHTML='';
        y.courses.forEach(c=>{
          let gOpts=''; letterGrades.forEach(g=> gOpts+=`<option value="${g}" ${c.letterGrade===g?'selected':''}>${g}</option>`);
          let lOpts=''; courseLevels.forEach(l=> lOpts+=`<option value="${l}" ${c.level===l?'selected':''}>${l}</option>`);
          coursesHTML+=`
            <div class="course-grid">
              <div class="form-group">${createCustomDropdown(y.id,c.id,c.name)}</div>
              <div class="form-group"><label class="form-label">Grade</label><select class="form-select" onchange="updateCourse(${y.id},${c.id},'letterGrade',this.value)">${gOpts}</select></div>
              <div class="form-group"><label class="form-label">Credits</label><input type="number" step="0.5" value="${c.credits}" class="form-input" oninput="updateCourse(${y.id},${c.id},'credits', parseFloat(this.value)||0)"></div>
              <div class="form-group"><label class="form-label">Level</label><select class="form-select" onchange="updateCourse(${y.id},${c.id},'level',this.value)">${lOpts}</select></div>
              <div class="form-group" style="align-self:center"><button class="button danger" onclick="removeCourse(${y.id},${c.id})" title="Delete Course">√ó</button></div>
            </div>`;
        });

        const removeBtn = years.length>1 ? `<button class="button danger" onclick="removeYear(${y.id})" title="Delete Year">√ó</button>` : '';
        const emptyState = y.courses.length===0 ? `<div class="empty-state">No courses yet. Click \"Add Course\" below.</div>` : '';
        const headerRow = y.courses.length>0 ? `<div class="course-header"><div>Course Name</div><div>Grade</div><div>Credits</div><div>Level</div><div></div></div>` : '';

        // Replaced MASS with Import PDF
        yearDiv.innerHTML = `
          <div class="year-header" data-year="${y.id}" title="Drag to reorder">
            <div class="year-info">
              <input type="text" value="${y.name}" class="year-name" oninput="updateYearName(${y.id}, this.value)">
              <div class="year-gpa">Weighted: ${weighted} | Unweighted: ${unweighted} | Credits: ${credits}</div>
            </div>
            <div class="year-buttons">
              ${removeBtn}
              <button class="button primary" onclick="openPdfPicker(${y.id})">üìÑ Import PDF</button>
              <button class="button secondary" onclick="toggleDebug()">üîß Toggle Debug</button>
              <input type="file" id="pdf-input-${y.id}" class="hidden" accept="application/pdf" onchange="handlePDFImport(event, ${y.id})">
            </div>
          </div>
          <div class="courses-container">${headerRow}${coursesHTML}${emptyState}</div>
          <div class="course-actions"><button class="button success" onclick="addCourse(${y.id})">‚ûï Add Course</button></div>`;

        container.appendChild(yearDiv);

        const header = yearDiv.querySelector('.year-header');
        header.draggable = true; header.addEventListener('dragstart', (e)=>onDragStart(e, y.id)); header.addEventListener('dragover', (e)=>onDragOver(e, y.id)); header.addEventListener('dragleave', (e)=>onDragLeave(e)); header.addEventListener('drop', (e)=>onDrop(e, y.id)); header.addEventListener('dragend', onDragEnd);
      });
    }

    function updateYearName(id, name){ const y=years.find(y=>y.id===id); if(y) y.name=name; }

    // ===== Custom dropdown (search by name) =====
    function createCustomDropdown(yearId, courseId, currentValue=''){
      const dropdownId=`dropdown-${yearId}-${courseId}`; const inputId=`input-${yearId}-${courseId}`;
      return `
        <div class="custom-dropdown" id="${dropdownId}">
          <label class="form-label">Course</label>
          <input type="text" id="${inputId}" value="${currentValue||''}" class="custom-dropdown-input" placeholder="Type to search courses..." autocomplete="off" onkeyup="filterCourses(${yearId},${courseId},this.value)" onkeydown="handleDropdownKeydown(event,${yearId},${courseId})" onfocus="showDropdown(${yearId},${courseId})" onblur="updateCourseFromInput(${yearId},${courseId},this.value); hideDropdown(${yearId},${courseId})">
          <div class="custom-dropdown-list hidden" id="list-${yearId}-${courseId}">${generateCourseOptions(yearId,courseId,'')}</div>
        </div>`;
    }

    function generateCourseOptions(yearId, courseId, filter=''){
      const norm = (s)=> String(s||'').toLowerCase();
      const rows = [];
      for (const [name, d] of Object.entries(courseCatalog)){
        if (!filter) { rows.push({ name, d }); continue; }
        const f = norm(filter);
        if (norm(name).includes(f)) rows.push({ name, d });
      }
      if(!rows.length) return '<div class="no-results">No courses found</div>';
      const items = rows.slice(0, 50).map(({name,d})=>{
        const safeName = name.replace(/'/g, "\\'");
        const label = `${name} ${d.subject?`<span style=\"opacity:.65\">(${d.subject})</span>`:''}`;
        return `<div class=\"custom-dropdown-item\" onmousedown=\"selectCourse(${yearId},${courseId},'${safeName}')\">${label}</div>`;
      }).join('');
      return items;
    }
    function filterCourses(yearId, courseId, value){ byId(`list-${yearId}-${courseId}`).innerHTML = generateCourseOptions(yearId,courseId,value); }
    function showDropdown(yearId, courseId){ byId(`list-${yearId}-${courseId}`).classList.remove('hidden'); }
    function hideDropdown(yearId, courseId){ setTimeout(()=> byId(`list-${yearId}-${courseId}`).classList.add('hidden'), 150); }
    function updateCourseFromInput(yearId, courseId, value){ updateCourse(yearId,courseId,'name',value); }
    function selectCourse(yearId, courseId, name){ const input=byId(`input-${yearId}-${courseId}`); input.value=name; hideDropdown(yearId,courseId); updateCourse(yearId,courseId,'name',name); }
    function handleDropdownKeydown(event, yearId, courseId){ const list=byId(`list-${yearId}-${courseId}`); const items=list.querySelectorAll('.custom-dropdown-item'); if(event.key==='Enter'){ const hi=list.querySelector('.custom-dropdown-item.highlighted'); if(hi) hi.dispatchEvent(new Event('mousedown')); }
      if(event.key==='ArrowDown'||event.key==='ArrowUp'){ event.preventDefault(); let hi=list.querySelector('.custom-dropdown-item.highlighted'); if(!hi){ (items[0]||{}).classList?.add('highlighted'); return; } hi.classList.remove('highlighted'); hi = event.key==='ArrowDown' ? hi.nextElementSibling||items[0] : hi.previousElementSibling||items[items.length-1]; hi.classList.add('highlighted'); }
      if(event.key==='Escape'){ list.classList.add('hidden'); }
    }

    // ===== Drag & drop (header only) =====
    let draggedYearId = null;
    function onDragStart(e, id){ draggedYearId = id; e.dataTransfer.effectAllowed='move'; }
    function onDragOver(e, targetId){ e.preventDefault(); e.dataTransfer.dropEffect='move'; const header=e.currentTarget; const rect=header.getBoundingClientRect(); const before = e.clientY < rect.top + rect.height/2; header.classList.toggle('drag-over-top', before); header.classList.toggle('drag-over-bottom', !before); }
    function onDragLeave(e){ e.currentTarget.classList.remove('drag-over-top','drag-over-bottom'); }
    function onDrop(e, targetId){ e.preventDefault(); const header=e.currentTarget; header.classList.remove('drag-over-top','drag-over-bottom'); if(draggedYearId===null || draggedYearId===targetId) return; const from = years.findIndex(y=>y.id===draggedYearId); const to = years.findIndex(y=>y.id===targetId); if(from<0||to<0) return; const rect=header.getBoundingClientRect(); let insertIndex = e.clientY < rect.top + rect.height/2 ? to : to+1; if(from < insertIndex) insertIndex--; const [m] = years.splice(from,1); years.splice(insertIndex,0,m); draggedYearId=null; renderYears(); }
    function onDragEnd(){ draggedYearId=null; Array.from(document.querySelectorAll('.year-header')).forEach(h=>h.classList.remove('drag-over-top','drag-over-bottom')); }

    // ===== PDF Import =====
    function openPdfPicker(yearId){
      const input = byId(`pdf-input-${yearId}`);
      if(!input){ console.warn('No file input found for year', yearId); return; }
      input.click();
    }
    function toggleDebug(){ byId('debug-card').classList.toggle('hidden'); }

    async function handlePDFImport(event, yearId){
  try{
    const file = event.target.files && event.target.files[0];
    if(!file){ return; }

    const arrayBuffer = await file.arrayBuffer();
    if(!window.pdfjsLib){ alert('PDF.js failed to load. Check the browser console for errors.'); return; }

    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
    let fullText = '';

    for(let p=1;p<=pdf.numPages;p++){
      const page = await pdf.getPage(p);
      const content = await page.getTextContent();
      const strings = content.items.map(i => ('str' in i ? i.str : i) || '');

      // Flatten to a line, then insert newlines before course starts and after grades.
      let pageText = strings.join(' ').replace(/\s+/g,' ').trim();
      pageText = pageText
        // very likely pattern: "Course Name ####-#" -> put a newline before this
        .replace(/\b([A-Z][A-Za-z\.\/'&\-\s]{2,})\s(\d{4}-\d)\b/g, '\n$1 $2')
        // put a newline after each grade we see to break ‚Äúrows‚Äù
        .replace(/(A\+|A-|\bA\b|B\+|B-|\bB\b|C\+|C-|\bC\b|D\+|D-|\bD\b|\bF\b)\s+(?=\d|[A-Z])/g, '$1\n')
        // normalize code fragment spacing
        .replace(/(\d{4}-\d+)\s+/g, '$1 ');

      fullText += (p>1?'\n':'') + pageText;
    }

    // Always show what we extracted
    const dbg = document.getElementById('pdf-debug');
    if (dbg){
      dbg.textContent = fullText || '[no text extracted]';
      document.getElementById('debug-card').classList.remove('hidden');
    }

    // Primary parse (your existing logic)
    let parsed = parseReportCard(fullText);

    // Fallback parse if nothing matched: grab broad chunks like
    // "<name> ####-# ... <many grades> ... <first decimal credits>"
    if(!parsed.length){
      const chunks=[];
      const re = /([A-Za-z0-9\.\/'&\-\s]+?)\s(\d{4}-\d)\b[\s\S]{0,120}?((?:A\+|A-|A|B\+|B-|B|C\+|C-|C|D\+|D-|D|F)(?:\s+(?:A\+|A-|A|B\+|B-|B|C\+|C-|C|D\+|D-|D|F)){1,7})[\s\S]{0,60}?(\\d+\.(?:\\d{1,3}))?/g;
      let m;
      while((m = re.exec(fullText))){
        const rawName = (m[1]||'').replace(/\s+/g,' ').trim();
        const codePart = m[2];
        const gradesBlob = m[3];
        const decimal = m[4] ? parseFloat(m[4]) : null;

        const grades = gradesBlob.match(/A\+|A-|\bA\b|B\+|B-|\bB\b|C\+|C-|\\bC\\b|D\\+|D-|\\bD\\b|F\\b/g) || [];
        const finalGrade = grades[grades.length-1];
        if(!finalGrade) continue;

        let name = rawName;
        let level = inferLevelFromName(name);
        let credits = decimal || 5;

        const code4 = codePart.slice(0,4);
        if (courseCatalogByCode[code4]){
          const cat = courseCatalogByCode[code4];
          name = cat.name; level = cat.level; credits = cat.credits;
        }
        chunks.push({ code: (courseCatalog[name]?.code) || code4, name, letterGrade: finalGrade, credits, level });
      }
      parsed = chunks;
    }

    if(!parsed.length){
      alert('I could not find any course rows in this PDF. Open the Debug panel to see the raw text we got.');
      return;
    }

    const y = years.find(y=>y.id===yearId); if(!y) return;
    parsed.forEach(p=>{
      y.courses.push({ id: Date.now()+Math.random(), code: p.code||'', name: p.name, letterGrade: p.letterGrade, credits: p.credits, level: p.level, isCustom: !courseCatalog[p.name] });
    });
    renderYears();
    updateGPA();

    // allow re-upload of the same file
    event.target.value = '';

  } catch(err){
    console.error('PDF import failed:', err);
    alert('PDF import failed. Open the console (F12) and tell me the red error message.');
  }
}


    function inferLevelFromName(name){
      const n = (name||'').toLowerCase();
      if (n.includes('ap ') || n.startsWith('ap')) return 'AP';
      if (n.includes('honors') || n.startsWith('hon ') || n.includes(' hon ')) return 'H';
      if (n.includes('adv') && !n.includes('advertis')) return 'ADV';
      return 'CP';
    }
    function cleanCourseName(raw){ return String(raw||'').replace(/\s+/g,' ').replace(/\u00A0/g,' ').trim().replace(/\s{2,}/g,' '); }
    function findBestCatalogMatch(name){
      if(courseCatalog[name]) return name;
      const target = name.replace(/[^a-z0-9 ]/ig,'').toLowerCase();
      let best=null, score=0;
      for (const key of Object.keys(courseCatalog)){
        const norm = key.replace(/[^a-z0-9 ]/ig,'').toLowerCase();
        if (target===norm){ best=key; score=1; break; }
        let s=0;
        if (norm.includes(target)) s = target.length / norm.length;
        if (target.includes(norm)) s = Math.max(s, norm.length / target.length);
        if (s>score){ score=s; best=key; }
      }
      return best && score>=0.5 ? best : null;
    }

    function parseReportCard(text){
      // Normalize newlines to increase hit-rate on messy PDFs
      const rough = text
        .replace(/\r/g,'\n')
        .replace(/\n{2,}/g,'\n')
        .replace(/\s{2,}/g,' ');

      const lines = rough.split(/\n+/).map(l=>l.trim()).filter(Boolean);
      const results = [];
      for (const line of lines){
        // must contain a 4-digit code OR look like a subject line with a trailing letter grade
        const codeMatch = line.match(/\b(\d{4})(?:-\d+)?\b/);
        const foundCode = codeMatch ? codeMatch[1] : null;

        // Find a trailing letter grade (final grade); pick the last match on the line
        const gradeRegex = /A\+|A-|\bA\b|B\+|B-|\bB\b|C\+|C-|\bC\b|D\+|D-|\bD\b|F\b/g;
        const gradeMatches = [...line.matchAll(gradeRegex)].map(m=>m[0]);
        const finalGrade = gradeMatches.length ? gradeMatches[gradeMatches.length-1] : null;
        if (!finalGrade && !foundCode) continue; // skip headers and noise

        // Course name = text before the code (common case) otherwise the whole line minus tail tokens
        let namePart = line;
        if (codeMatch) namePart = line.slice(0, line.indexOf(codeMatch[0])).trim();

        // Credits: first decimal number like 7.000; if none, will be filled from catalog default
        let credits = null;
        const creditMatches = [...line.matchAll(/(\d+\.(?:\d{1,3}))/g)].map(m=>parseFloat(m[1]));
        if (creditMatches.length) credits = creditMatches[0];

        let courseName = cleanCourseName(namePart);
        let level = inferLevelFromName(courseName);

        if (foundCode && courseCatalogByCode[foundCode]){
          const cat = courseCatalogByCode[foundCode];
          courseName = cat.name; level = cat.level; if (!credits) credits = cat.credits;
        } else {
          const catName = findBestCatalogMatch(courseName);
          if (catName){ const cat = courseCatalog[catName]; courseName = catName; level = cat.level; if (!credits) credits = cat.credits; }
        }

        if (courseName && finalGrade){
          const code = (courseCatalog[courseName]?.code) || foundCode || '';
          results.push({ code, name: courseName, letterGrade: finalGrade, credits: credits || 5, level });
        }
      }
      // de-dupe by name|grade
      const seen = new Set();
      return results.filter(r=>{ const k=r.name+'|'+r.letterGrade; if (seen.has(k)) return false; seen.add(k); return true; });
    }

    // ===== Export / Import (JSON) =====
    function exportData(){ const data={ years, exportDate:new Date().toISOString() }; const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='gpa-data.json'; a.click(); URL.revokeObjectURL(url); }
    function importData(event){ const file=event.target.files[0]; if(!file) return; const r=new FileReader(); r.onload=e=>{ try{ const data=JSON.parse(e.target.result); if(Array.isArray(data.years)){ years=data.years; renderYears(); updateGPA(); } } catch(err){ alert('Error importing data. Please check the file format.'); } }; r.readAsText(file); }

    // ===== Grade calculator =====
    function updateGradeInputs(){ const isAP=byId('is-ap').checked; const isSem=byId('is-semester').checked; byId('mp3-container').style.display = isSem?'none':'block'; byId('mp4-container').style.display = isSem?'none':'block'; byId('final-exam-container').style.display = isAP?'none':'block'; ['mp1','mp2','mp3','mp4','final-exam'].forEach(id=>{ const el=byId(id); if(el) el.value=''; }); calculateFinalGrade(); }
    function percentageToGradePoints(p){ if(p>=97) return 4.3; if(p>=93) return 4.0; if(p>=90) return 3.7; if(p>=87) return 3.3; if(p>=83) return 3.0; if(p>=80) return 2.7; if(p>=77) return 2.3; if(p>=73) return 2.0; if(p>=70) return 1.7; if(p>=67) return 1.3; if(p>=63) return 1.0; if(p>=60) return 0.7; return 0.0; }
    function gradePointsToLetterGrade(x){ if(x>=4.15) return 'A+'; if(x>=3.85) return 'A'; if(x>=3.50) return 'A-'; if(x>=3.15) return 'B+'; if(x>=2.85) return 'B'; if(x>=2.50) return 'B-'; if(x>=2.15) return 'C+'; if(x>=1.85) return 'C'; if(x>=1.50) return 'C-'; if(x>=1.15) return 'D+'; if(x>=0.85) return 'D'; if(x>=0.50) return 'D-'; return 'F'; }
    function calculateFinalGrade(){ const isAP=byId('is-ap').checked; const isSem=byId('is-semester').checked; const v=id=>parseFloat(byId(id).value); const mp1=v('mp1'), mp2=v('mp2'); const mp3=isSem?null:v('mp3'); const mp4=isSem?null:v('mp4'); const fe=isAP?null:v('final-exam'); if(Number.isNaN(mp1)||Number.isNaN(mp2)) return byId('grade-results').classList.add('hidden'); if(!isSem && (Number.isNaN(mp3)||Number.isNaN(mp4))) return byId('grade-results').classList.add('hidden'); if(!isAP && Number.isNaN(fe)) return byId('grade-results').classList.add('hidden'); const mp1p=percentageToGradePoints(mp1), mp2p=percentageToGradePoints(mp2), mp3p=mp3!=null?percentageToGradePoints(mp3):null, mp4p=mp4!=null?percentageToGradePoints(mp4):null, fep=fe!=null?percentageToGradePoints(fe):null; let finalPts; if(isAP){ finalPts = isSem? (mp1p*.5 + mp2p*.5) : (mp1p*.25 + mp2p*.25 + mp3p*.25 + mp4p*.25); } else { finalPts = isSem? (mp1p*.45 + mp2p*.45 + fep*.10) : (mp1p*.225 + mp2p*.225 + mp3p*.225 + mp4p*.225 + fep*.10); } byId('final-points').textContent = finalPts.toFixed(3); byId('final-letter').textContent = gradePointsToLetterGrade(finalPts); byId('grade-results').classList.remove('hidden'); }

    // ===== Utils =====
    function byId(id){ return document.getElementById(id); }
    document.addEventListener('click', (event)=>{ const dropdowns=document.querySelectorAll('.custom-dropdown-list'); dropdowns.forEach(dd=>{ if(!dd.parentElement.contains(event.target)) dd.classList.add('hidden'); }); });
  </script>
</body>
</html>
